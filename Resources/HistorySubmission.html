<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>WDSA | Submission History</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; padding: 20px; background: #f1f5f9; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        h1 { color: #1a472a; border-bottom: 2px solid #e2e8f0; padding-bottom: 15px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #e2e8f0; }
        th { background-color: #f8fafc; font-weight: 600; color: #475569; }
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600; }
        .success { background: #dcfce7; color: #166534; }
        .fail { background: #fee2e2; color: #991b1b; }
        .view-code-btn { cursor: pointer; color: #2563eb; text-decoration: underline; }
        #codeModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
        .modal-content { background: white; width: 80%; max-width: 800px; margin: 50px auto; padding: 20px; border-radius: 8px; height: 80vh; display: flex; flex-direction: column; }
        textarea { width: 100%; flex: 1; font-family: monospace; padding: 10px; margin-top: 10px; }
        .close-btn { align-self: flex-end; cursor: pointer; font-weight: bold; font-size: 20px; }
    </style>
</head>
<body>

<div class="container">
    <h1>Submission History</h1>
    <button onclick="loadData()" style="padding: 8px 16px; background: #2d7a4e; color: white; border: none; border-radius: 6px; cursor: pointer;">Refresh Data</button>
    
    <table>
        <thead>
            <tr>
                <th>Time Submit</th>
                <th>User ID</th>
                <th>Name Problem</th> 
                <th>Result</th>
                <th>Time Complexity</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody id="tableBody">
            <tr><td colspan="6">Loading data...</td></tr>
        </tbody>
    </table>
</div>

<div id="codeModal">
    <div class="modal-content">
        <span class="close-btn" onclick="document.getElementById('codeModal').style.display='none'">&times;</span>
        <h3>Submitted Code</h3>
        <textarea id="modalCode" readonly></textarea>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

<script>
    // ⚠️ COPY CONFIG GIỐNG EDITOR.HTML (Bao gồm databaseURL)
    const firebaseConfig = {
        // ... các config khác ...
        databaseURL: "https://wdsa-6c250-default-rtdb.asia-southeast1.firebasedatabase.app",
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    let allSubmissions = {}; // Lưu trữ để xem code

    function loadData() {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '<tr><td colspan="6">Updating...</td></tr>';
        
        // Lấy 50 submission cuối cùng
        db.ref('submissions').limitToLast(50).once('value', (snapshot) => {
            const data = snapshot.val();
            
            if (!data) {
                tbody.innerHTML = '<tr><td colspan="6">No submissions found.</td></tr>';
                return;
            }

            allSubmissions = data; // Lưu lại để dùng cho viewCode
            tbody.innerHTML = '';

            // Chuyển object thành array để sắp xếp
            const entries = Object.entries(data).map(([key, val]) => ({
                id: key,
                ...val
            }));

            // Sắp xếp mới nhất lên đầu
            entries.sort((a, b) => b.timestamp - a.timestamp);

            entries.forEach(item => {
                

                // ... bên trong vòng lặp forEach ...
                    const date = new Date(item.timestamp).toLocaleString();
                    const statusClass = item.status === 'Accepted' ? 'success' : 'fail';
                    
                    // Xử lý trường hợp dữ liệu cũ chưa có tên
                    const displayName = item.userName || "Unknown"; 

                    const row = `
                        <tr>
                            <td style="font-size: 13px; color: #64748b;">${date}</td>
                            
                            <td style="font-weight:bold; color: #1e293b;">${displayName}</td>
                            
                            <td>${item.problemTitle}</td>
                            <td><span class="badge ${statusClass}">${item.status}</span></td>
                            <td>${item.runtime}s</td>
                            <td><span class="view-code-btn" onclick="viewCode('${item.id}')">View Code</span></td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
            });
        });
    }

    function viewCode(id) {
        if(allSubmissions[id]) {
            document.getElementById('modalCode').value = allSubmissions[id].code;
            document.getElementById('codeModal').style.display = 'block';
        }
    }

    loadData();
</script>
</body>
</html>